<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Maxi Yacht COâ‚‚ Estimator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script></head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;
    const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } = Recharts;

    // =============================
    // ðŸ”¥ BACKEND RENDER COLLEGATO
    // =============================
    const API_BASE = "https://yacht-api-ynd6.onrender.com";

    const CO2_PER_LITER = 2.68;

    function generateEmbeddedData() {
      const list = [];
      for (let i = 0; i < 1000; i++) {
        const length = 180 - i * 0.11 + (Math.random() * 2 - 1);
        const power = 10000 + (length - 60) * 110;
        const consumption = power * 0.22;
        const co2h = consumption * CO2_PER_LITER;
        const co2y = (co2h * 800) / 1000;

        list.push({
          Name: `Yacht_${String(i + 1).padStart(4, '0')}`,
          Length_m: length.toFixed(1),
          EnginePower_kW_est: Math.round(power),
          CO2_t_per_year_est: Number(co2y.toFixed(1))
        });
      }
      return list;
    }

    const EMBEDDED_DATA = generateEmbeddedData();

    function enrich(row) {
      const power = Number(row.EnginePower_kW_est || 0);
      const consumption = power * 0.22;
      const co2h = consumption * CO2_PER_LITER;
      const co2y = (co2h * 800) / 1000;
      return { ...row, consumption, co2h, co2y };
    }

    function KPI({ title, value, unit }) {
      return (
        <div className="bg-white rounded-2xl shadow p-6 text-center">
          <div className="text-slate-500 text-sm">{title}</div>
          <div className="text-2xl font-bold mt-2">{value} {unit}</div>
        </div>
      );
    }

    function App() {
      const BATCH_SIZE = 50;
      const [visibleCount, setVisibleCount] = useState(BATCH_SIZE);
      const [sortKey, setSortKey] = useState('co2y');
      const [sortDir, setSortDir] = useState('desc');
      const [data, setData] = useState(EMBEDDED_DATA);
      const [search, setSearch] = useState("");
      const [loadingApi, setLoadingApi] = useState(false);

      // =====================================
      // ðŸ”¥ CARICAMENTO AUTOMATICO DAL BACKEND
      // =====================================
      useEffect(() => {
        async function loadFromAPI() {
          try {
            setLoadingApi(true);
            const res = await fetch(API_BASE + "/api/yachts");
            const json = await res.json();

            if (Array.isArray(json) && json.length) {
              const mapped = json.map(y => ({
                Name: y.name || y.Name,
                Length_m: y.length || y.Length_m || 0,
                EnginePower_kW_est: 12000
              }));
              setData(mapped);
            }
          } catch (e) {
            console.log("Backend non raggiungibile, uso dataset locale");
          } finally {
            setLoadingApi(false);
          }
        }

        loadFromAPI();
      }, []);

      function setSort(key){
        if(sortKey===key) setSortDir(d=>d==='asc'?'desc':'asc');
        else{ setSortKey(key); setSortDir('desc'); }
      }

      function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
          let json;
          if (file.name.endsWith('.json')) json = JSON.parse(evt.target.result);
          else {
            const workbook = XLSX.read(evt.target.result, { type: 'binary' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            json = XLSX.utils.sheet_to_json(sheet);
          }
          setData(json);
        };

        if (file.name.endsWith('.json')) reader.readAsText(file);
        else reader.readAsBinaryString(file);
      }

      function exportCSV() {
        const rows = data.map(enrich);
        const header = Object.keys(rows[0]).join(',');
        const body = rows.map(r => Object.values(r).join(',')).join('\n');
        const blob = new Blob([header + '\n' + body]);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'yachts.csv';
        a.click();
      }

      function exportJSON() {
        const blob = new Blob([JSON.stringify(data, null, 2)]);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'yachts.json';
        a.click();
      }

      const rows = useMemo(() => {
        let filtered = data
          .map(enrich)
          .filter(r => r.Name.toLowerCase().includes(search.toLowerCase()));

        filtered.sort((a,b)=>{
          const A = a[sortKey];
          const B = b[sortKey];
          if(typeof A === 'string') return sortDir==='asc'?A.localeCompare(B):B.localeCompare(A);
          return sortDir==='asc'?A-B:B-A;
        });

        return filtered;
      }, [data, search, sortKey, sortDir]);

      const visibleRows = rows.slice(0, visibleCount);

      useEffect(()=>{
        setVisibleCount(BATCH_SIZE);
      }, [search, data, sortKey, sortDir]);

      const stats = useMemo(() => {
        const values = rows.map(r => r.co2y);
        const total = values.reduce((a,b)=>a+b,0);
        const avg = total / (values.length || 1);
        const max = Math.max(...values);
        return {
          total: total.toFixed(0),
          avg: avg.toFixed(1),
          max: max.toFixed(1)
        };
      }, [rows]);

      const top10 = useMemo(() => {
        return [...rows]
          .sort((a,b)=>b.co2y-a.co2y)
          .slice(0,10)
          .map(r => ({ name: r.Name, value: r.co2y }));
      }, [rows]);

      return (
        <div className="max-w-7xl mx-auto p-8 space-y-8">
          <h1 className="text-3xl font-bold">Maxi Yacht COâ‚‚ Dashboard</h1>

          {loadingApi && (
            <div className="text-sm text-slate-500">ðŸ”„ Caricamento dati dal backendâ€¦</div>
          )}

          <div className="grid md:grid-cols-4 gap-4 items-center">
            <label className="cursor-pointer bg-blue-600 text-white rounded-2xl p-4 text-center font-semibold">
              ðŸ“‚ Carica Excel / CSV / JSON
              <input type="file" accept=".xlsx,.csv,.json" onChange={handleFile} className="hidden" />
            </label>
            <button onClick={exportCSV} className="bg-black text-white rounded-2xl p-3">Esporta CSV</button>
            <button onClick={exportJSON} className="bg-black text-white rounded-2xl p-3">Esporta JSON</button>
            <input placeholder="ðŸ” Cerca yacht..." value={search} onChange={e=>setSearch(e.target.value)} className="p-3 rounded-2xl shadow bg-white" />
          </div>

          <div className="grid md:grid-cols-3 gap-6">
            <KPI title="Totale emissioni" value={stats.total} unit="t/anno" />
            <KPI title="Media per yacht" value={stats.avg} unit="t/anno" />
            <KPI title="Massimo singolo" value={stats.max} unit="t/anno" />
          </div>

          <div className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4">Top 10 yacht per emissioni annuali</h2>
            <div style={{ width: '100%', height: 300 }}>
              <ResponsiveContainer>
                <BarChart data={top10}>
                  <XAxis dataKey="name" hide />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="value" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="overflow-auto rounded-2xl shadow bg-white" style={{maxHeight:'60vh'}} onScroll={(e)=>{ const el=e.currentTarget; if(el.scrollTop + el.clientHeight >= el.scrollHeight - 10){ setVisibleCount(v=>Math.min(v + BATCH_SIZE, rows.length)); } }}>
            <table className="w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="p-3 text-left cursor-pointer" onClick={()=>setSort('Name')}>Nome â†•</th>
                  <th className="p-3 cursor-pointer" onClick={()=>setSort('Length_m')}>Lunghezza â†•</th>
                  <th className="p-3 cursor-pointer" onClick={()=>setSort('co2y')}>COâ‚‚ t/anno â†•</th>
                </tr>
              </thead>
              <tbody>
                {visibleRows.map((r,i)=>(
                  <tr key={i} className="border-t">
                    <td className="p-3">{r.Name}</td>
                    <td className="p-3 text-center">{r.Length_m}</td>
                    <td className="p-3 text-center">{r.co2y.toFixed(1)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="text-center text-xs text-slate-500 mt-2">
            Visualizzate {visibleRows.length} di {rows.length} righe â€” scroll infinito attivo
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
